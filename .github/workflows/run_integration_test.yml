name: Run Integration Test - (Playwright + Overseer)

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Environment to test"
        required: true
        type: choice
        options: [sandbox, staging, production]
      branch:
        description: "Nightveil branch to test"
        required: true
        default: "main"

jobs:
  integration-test:
    runs-on: ubuntu-latest

    env:
      NODE_ENV: test
      ORDER_READY_DELAY: 5000
      GOOGLE_APPLICATION_CREDENTIALS: ${{ github.workspace }}/overseer-sandbox.json

    steps:
      - name: Verify access to Felix-Pago/nightveil
        run: |
          git ls-remote https://x-access-token:${{ secrets.GH_PAT }}@github.com/Felix-Pago/nightveil.git

      - name: Checkout Framework
        uses: actions/checkout@v4

      - name: Checkout Nightveil (Frontend)
        uses: actions/checkout@v4
        with:
          repository: Felix-Pago/nightveil
          ref: ${{ github.event.inputs.branch }}
          token: ${{ secrets.GH_PAT }}
          path: nightveil

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: felix-tech-production
          service_account_key: ${{ secrets.GCP_SERVICE_KEY }}

      - name: Create .npmrc for Artifact Registry
        run: |
          TOKEN=$(gcloud auth print-access-token)
          cat <<EOF > ~/.npmrc
@felix:registry=https://us-central1-npm.pkg.dev/felix-tech-production/overseer-sdk-ts/
//us-central1-npm.pkg.dev/felix-tech-production/overseer-sdk-ts/:_authToken=$TOKEN
always-auth=true
EOF

      - name: Install dependencies (framework)
        run: npm ci

      - name: Install dependencies (nightveil)
        run: |
          cd nightveil
          npm ci

      - name: Setup Playwright browsers
        run: npm run install-browsers

      - name: Decode and write Overseer GCP credentials
        run: |
          echo "${{ secrets.GCP_SERVICE_KEY }}" | base64 --decode > overseer-sandbox.json

      - name: Run Integration Test
        run: npm run integration-test

      - name: Upload Playwright HTML report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report/
